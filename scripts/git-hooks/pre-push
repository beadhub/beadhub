#!/bin/sh
# BeadHub repo pre-push hook
#
# 1) Prevent pushing stale .beads JSONL (mirrors bd's hook)
# 2) Run code checks before pushing (Python, frontend, Go)

set -eu

# ---- beads JSONL guard (mirrors bd's hook) ----
if [ -d .beads ]; then
  SKIP_BEADS_CHECK=0
  SYNC_BRANCH="${BEADS_SYNC_BRANCH:-}"
  if [ -z "$SYNC_BRANCH" ] && [ -f .beads/config.yaml ]; then
    SYNC_BRANCH=$(grep -E '^sync-branch:' .beads/config.yaml 2>/dev/null | head -1 | sed 's/^sync-branch:[[:space:]]*//' | sed 's/^["'"'"']//' | sed 's/["'"'"']$//')
  fi

  if [ -n "$SYNC_BRANCH" ]; then
    # When sync-branch is configured, .beads changes are committed via a separate
    # worktree/branch, so this hook must not block pushes based on local JSONL.
    SKIP_BEADS_CHECK=1
  fi

  if [ "$SKIP_BEADS_CHECK" = "0" ]; then
    if command -v bd >/dev/null 2>&1; then
      bd sync --flush-only >/dev/null 2>&1 || true
    fi

    FILES=""
    for f in .beads/beads.jsonl .beads/issues.jsonl .beads/deletions.jsonl; do
      if git ls-files --error-unmatch "$f" >/dev/null 2>&1 || [ -f "$f" ]; then
        FILES="$FILES $f"
      fi
    done

    if [ -n "$FILES" ]; then
      # shellcheck disable=SC2086
      if [ -n "$(git status --porcelain -- $FILES 2>/dev/null)" ]; then
        echo "❌ Error: Uncommitted changes detected" >&2
        echo "" >&2
        echo "Before pushing, ensure all changes are committed. This includes:" >&2
        echo "  • bd JSONL updates (run 'bd sync')" >&2
        echo "  • any other modified files (run 'git status' to review)" >&2
        echo "" >&2

        if command -v bd >/dev/null 2>&1; then
          if [ -t 0 ]; then
            echo "Would you like to run 'bd sync' now to commit and push these changes? [y/N]" >&2
            read -r response
            case "$response" in
              [yY][eE][sS]|[yY])
                echo "" >&2
                echo "Running: bd sync" >&2
                if bd sync; then
                  echo "" >&2
                  echo "✓ Sync complete. Continuing with push..." >&2
                  exit 0
                else
                  echo "" >&2
                  echo "❌ Sync failed. Push aborted." >&2
                  exit 1
                fi
                ;;
              *)
                echo "" >&2
                echo "Push aborted. Run 'bd sync' manually when ready:" >&2
                echo "" >&2
                echo "  bd sync" >&2
                echo "  git push" >&2
                echo "" >&2
                exit 1
                ;;
            esac
          else
            echo "Run 'bd sync' to commit these changes:" >&2
            echo "" >&2
            echo "  bd sync" >&2
            echo "" >&2
            exit 1
          fi
        else
          echo "Please commit the updated JSONL before pushing:" >&2
          echo "" >&2
          # shellcheck disable=SC2086
          echo "  git add $FILES" >&2
          echo '  git commit -m "Update bd JSONL"' >&2
          echo "  git push" >&2
          echo "" >&2
          exit 1
        fi
      fi
    fi
  fi
fi

# ---- Python checks ----
if [ "${BEADHUB_SKIP_PREPUSH_CHECKS:-}" = "1" ]; then
  exit 0
fi

if command -v uv >/dev/null 2>&1; then
  echo "Running Python checks (ruff/black/isort/mypy)..." >&2
  make -s check-python
else
  echo "Warning: uv not found; skipping Python checks (set BEADHUB_SKIP_PREPUSH_CHECKS=1 to silence)" >&2
fi

if command -v pnpm >/dev/null 2>&1 && [ -d frontend/node_modules ]; then
  echo "Running frontend checks (eslint)..." >&2
  make -s check-frontend
else
  echo "Warning: frontend deps not installed; skipping frontend checks (run 'pnpm -C frontend install')" >&2
fi

exit 0
