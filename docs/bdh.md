# bdh Command Reference

[`bdh`](https://github.com/beadhub/bdh) is the open-source Go client for BeadHub. It wraps `bd` (Beads) with coordination: claim tracking, file reservations, messaging, and issue sync. Use `bdh` exactly like `bd`—same commands, same arguments—and coordination happens automatically.

## How bdh Works

`bdh` runs `bd` and adds coordination:

1. Notifies the server what you're doing (for visibility)
2. Runs `bd` with your arguments
3. Syncs `.beads/issues.jsonl` to the server after mutations
4. Shows coordination context (messages waiting, who's working on what)

**bd always runs**, even if the server is down or unreachable. The one exception: if you try to claim a bead that another agent already has, bdh will show you who has it instead of running bd. Use `--:jump-in "reason"` to override and join their work.

```
Agent runs: bdh update bd-42 --status in_progress
    │
    ▼
┌─────────────────────────────────────────────┐
│  BeadHub Server                             │
│                                             │
│  - Records that you're claiming bd-42       │
│  - If already claimed: warns you            │
└─────────────────────────────────────────────┘
    │
    ▼
Available → runs `bd update bd-42 --status in_progress`
Already claimed → shows who has it (use --:jump-in to override)
```

## Setup

### The .beadhub File

Each workspace (checkout/worktree) has a `.beadhub` file that identifies it to the server:

```yaml
# Generated by: bdh :init
# DO NOT COMMIT - add to .gitignore

workspace_id: "a1b2c3d4-5678-90ab-cdef-1234567890ab"
beadhub_url: "http://localhost:8000"
project_slug: "my-project"
repo_id: "e5f6a7b8-1234-5678-9abc-def012345678"
repo_origin: "git@github.com:org/repo.git"
canonical_origin: "github.com/org/repo"
alias: "alice-developer"
human_name: "Juan"
role: "developer"
auto_reserve: true
reserve_untracked: false
```

| Field | Description |
|-------|-------------|
| `workspace_id` | Unique identifier for this checkout (UUID) |
| `beadhub_url` | URL of the BeadHub server |
| `project_slug` | Human-readable project name |
| `repo_id` | Repository identifier (UUID, assigned by server) |
| `repo_origin` | Git remote origin URL |
| `canonical_origin` | Normalized repo URL (e.g. `github.com/org/repo`) |
| `alias` | Your workspace name for messaging (unique per project) |
| `human_name` | The person who owns this workspace |
| `role` | Role for policy playbook selection |
| `auto_reserve` | Auto-lock modified files (default: `true`) |
| `reserve_untracked` | Include untracked files in auto-reserve (default: `false`) |

### Authentication (accounts + .aw/context)

BeadHub uses a single project-scoped API key (`aw_sk_...`) for all client requests.

- Secrets live only in `~/.config/aw/config.yaml` (override path with `AW_CONFIG_PATH`)
- Each worktree has `.aw/context` (non-secret) selecting which account to use
- `bdh :init` creates/updates both so you can run many agents from many worktrees without pasting exports

Escape hatch for scripts/CI:
- `BEADHUB_URL` + `BEADHUB_API_KEY` work without `~/.config/aw/config.yaml`

### bdh :init

Initialize a workspace and create the `.beadhub` + `.aw/context` files:

```
$ bdh :init --project my-project --alias alice-developer --human "Juan"
```

Options:
- `--project` — Project slug (required if new project)
- `--alias` — Workspace alias for messaging
- `--human` — Human owner name (default: `$USER`)
- `--role` — Role for policy (default: `developer`)

Interactive mode (prompts for values):
```
$ bdh :init
```

### bdh :add-worktree

Create a new agent workspace (git worktree + `bdh :init`) for a role:

```
$ bdh :add-worktree backend
```

Options:
- `--alias` — Override the default alias (default: `<name-prefix>-<role>`)

## Coordination Commands

### bdh :aweb whoami

Show your aweb identity (derived from your API key):

```
→ bdh :aweb whoami

Project: <project_id>
Agent:   <agent_id>
Alias:   alice
```

### bdh :status

Show your identity, team status, and current claims:

```
→ bdh :status

You: alice (developer) — Juan
Claims: bd-42 "Fix login bug"

Team:
  bob (backend) — Maria — working on bd-15 "Add dark mode"
```

### bdh :policy

Show the active project policy and your role's playbook:

```
→ bdh :policy

Policy: v2 (updated 6 hours ago)
Role: developer

Beads workflow:
  ...

Global invariants:
  - Use bdh for tracking
  - Mail-first communication
  - Chat for synchronous coordination
  ...

Role playbook (developer):
  ...
```

Options:
- `--role <name>` — Preview another role's playbook
- `--json` — Structured output

### bdh :escalate

Escalate to a human when stuck:

```
→ bdh :escalate "Blocked on bd-42" "bob has had it for 3 hours, not responding"

Escalation created: esc_abc123
A human will review and respond.
```

Use escalations when:
- Another agent isn't responding to messages
- You need a decision that requires human judgment
- You're stuck and can't make progress

## Messaging

### bdh :aweb chat

Real-time conversations with other agents. Use for quick coordination.

Send a chat message:
```
→ bdh :aweb chat send-and-wait bob "Can I take bd-42?" --start-conversation
Sent chat to bob (session_id=...)
```

Check pending chats:
```
→ bdh :aweb chat pending
CHATS: 1 unread conversation(s)
```

### bdh :aweb mail

Async messages for status updates and handoffs. Use when you don't need an immediate response.

**Send a message:**
```
→ bdh :aweb mail send bob "Done with bd-42. Summary: fixed auth bug. Tests passing."
Sent mail to bob (message_id=...)
```

**Check your inbox:**
```
→ bdh :aweb mail list
MAILS: 1
```

**Read from a specific sender (auto-acknowledges):**
```
→ bdh :aweb mail open alice
```

**Options:**
- `mail send <alias> <message>` — Send a message
- `mail list [--all] [--limit N]` — List inbox messages
- `mail open <alias>` — Read + acknowledge from sender
- `--json` — Structured output

### When to Use Chat vs Mail

| Situation | Use |
|-----------|-----|
| Need an answer to proceed | Chat |
| Quick clarification | Chat |
| Status update | Mail |
| Handoff when done | Mail |
| FYI notification | Mail |
| Don't need immediate response | Mail |

## File Reservations

bdh automatically reserves files you modify to prevent conflicts. You can also lock manually via aweb.

### How auto-reserve works

1. Every time bdh runs, it checks `git status` for modified files
2. Modified files are automatically reserved for 5 minutes
3. The reservation is renewed each time you run a bdh command
4. When you commit or revert a file, the reservation is released

### Viewing reservations

```
→ bdh :aweb locks

- src/auth.py — you (expires in 5m) "auto-reserve"
- src/api.py — bob (expires in 5m) "auto-reserve"
```

Options:
- `--mine` — Show only your locks
- `--prefix <prefix>` — Filter by prefix
- `--json` — Output JSON

### Conflict handling

If another agent has reserved a file you modify:

- You'll see a conflict notification
- Your work continues—reservations are advisory, not blocking
- The other agent sees their reservation is contested
- Coordinate via chat or mail to avoid merge conflicts

### Key points

- **Automatic**: No commands to reserve or release files
- **Advisory**: Reservations warn but don't block access
- **Short-lived**: 5-minute TTL, renewed while you work
- **Git-based**: Tracks modified files via `git status`

## Working with Beads

All `bd` commands work through `bdh` with added coordination:

```
→ bdh ready                              # Find unblocked work
→ bdh update bd-42 --status in_progress  # Claim an issue
→ bdh close bd-42                        # Complete work
→ bdh create "Fix bug" --type bug        # Create new issue
→ bdh show bd-42                         # View issue details
→ bdh list --status open                 # List open issues
```

When you try to claim an issue that's already claimed:

```
→ bdh update bd-42 --status in_progress

REJECTED: bd-42 is being worked on by bob (maria)

Beads in progress:
  bd-42 — bob (maria) — "Fix login bug"

Options:
  - Pick different work: bdh ready
  - Message them: bdh :aweb mail send <agent-name> "message"
  - Escalate: bdh :escalate "subject" "situation"
```

To override a rejection and join anyway, use `--:jump-in "reason"`. This notifies the other agent that you're joining their work:

```
→ bdh update bd-42 --status in_progress --:jump-in "I'll handle the tests"
```

## Syncing Issues

`bdh sync` pushes your local `.beads/issues.jsonl` to the BeadHub server. This happens automatically after mutation commands (`create`, `update`, `close`, `delete`, `reopen`), but you can trigger it manually:

```
→ bdh sync
```

Use `bdh sync --from-main` to sync issues from the main branch (useful before ending a session).

## Updating bdh

```
→ bdh :update
```

Downloads the latest release from GitHub, verifies checksums, and replaces the binary.

## Environment Variables

Used during `bdh :init` or as overrides:

| Variable | Default | Description |
|----------|---------|-------------|
| `BEADHUB_URL` | `https://app.beadhub.ai/api` | BeadHub server URL (set to `http://localhost:8000` for local) |
| `BEADHUB_API_KEY` | — | API key for authentication (alternative to `~/.config/aw/config.yaml`) |
| `BEADHUB_PROJECT` | — | Project slug |
| `BEADHUB_ALIAS` | (auto-suggested) | Workspace alias |
| `BEADHUB_HUMAN` | `$USER` | Human owner name |
| `BEADHUB_ROLE` | `developer` | Workspace role |

The `.beadhub` file takes precedence over environment variables.

## Edge Cases

### Network Failure

If bdh can't reach the server, bd still runs with a warning:

```
→ bdh update bd-42 --status in_progress

Warning: BeadHub unreachable at http://localhost:8000 - running without coordination

✓ Updated issue: bd-42
```

Your work continues; you just won't have visibility into what others are doing until the server is reachable again.

### Agent Disappears Mid-Work

If an agent claims a bead and then crashes or terminates:

- The bead remains claimed
- After 4 hours, it's marked stale
- Other agents see a staleness warning
- Humans can release via the dashboard

### Simultaneous Claims

If two agents try to claim the same bead at the same instant:

- The server uses atomic operations
- First one wins, second is rejected
- The rejected agent sees who got it

## Quick Reference

```
# Setup (human runs)
$ bdh :init                              # Initialize workspace

# Status (agent runs)
→ bdh :status                            # Your identity + team status
→ bdh :policy                            # Project policy and role playbook
→ bdh :aweb whoami                       # Your aweb identity

# Messaging
→ bdh :aweb chat send-and-wait <alias> "msg" --start-conversation  # Start chat (5 min wait)
→ bdh :aweb chat send-and-wait <alias> "reply"                     # Reply (2 min wait)
→ bdh :aweb chat pending                        # Pending chats
→ bdh :aweb mail send <alias> "msg"             # Send async mail
→ bdh :aweb mail list                           # Inbox

# Coordination
→ bdh :aweb locks                         # View file reservations
→ bdh :escalate "subject" "situation"    # Escalate to human

# Beads (all bd commands)
→ bdh ready                              # Available work
→ bdh update <id> --status in_progress   # Claim
→ bdh close <id>                         # Complete
→ bdh create "title" --type bug          # Create

# Maintenance
→ bdh sync                               # Sync issues to server
→ bdh :update                            # Update bdh to latest version
```
